stages:
  - build
  - deploy

.template: &build-template
  stage: build
  services:
    - name: docker:19.03.1-dind
      alias: docker
  variables:
    DOCKER_TLS_CERTDIR: ""
  tags:
    - docker-compose
  artifacts:
    expire_in: 2 mins
    paths:
      - variables
      - private_key

.docker-push-template: &docker-push |
  docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  docker build -t $CI_IMAGE_NAME:$VERSION .
  docker push "$CI_IMAGE_NAME:$VERSION"

.staging-server-env-template: &staging-server-env |
  echo "export CI_CONTAINER_INSTANCE_NAME=$CI_CONTAINER_INSTANCE_NAME" >> variables
  echo "export SSH_URL=$STAGING_BACKEND_URL" >> variables
  echo "export SSH_CMD=$STAGING_SSH" >> variables
  echo "export VERSION=$VERSION" >> variables
  echo "$STAGING_SSH_PRIVATE_KEY" >> private_key

.production-server-env-template: &production-server-env |
  echo "export CI_CONTAINER_INSTANCE_NAME=$CI_CONTAINER_INSTANCE_NAME" >> variables
  echo "export SSH_URL=$PRODUCTION_BACKEND_URL" >> variables
  echo "export SSH_CMD=$PRODUCTION_SSH" >> variables
  echo "export VERSION=$VERSION" >> variables
  echo "$PRODUCTION_SSH_PRIVATE_KEY" >> private_key

build-master:
  <<: *build-template
  only:
    - master
  environment:
    name: Master
  variables:
    VERSION: 2.0.0
    CI_CONTAINER_INSTANCE_NAME: arsnova-click-backend
  script:
    - *production-server-env
    - *docker-push

build-staging:
  <<: *build-template
  only:
    - staging
  environment:
    name: Staging
  variables:
    VERSION: 2.0.0-staging
    CI_CONTAINER_INSTANCE_NAME: arsnova-click-backend-staging
  script:
    - *staging-server-env
    - *docker-push

build-beta:
  <<: *build-template
  only:
    - beta
  environment:
    name: Beta
  variables:
    VERSION: 2.0.0-beta
    CI_CONTAINER_INSTANCE_NAME: arsnova-click-backend-beta
  script:
    - *staging-server-env
    - *docker-push

build-snapshot:
  <<: *build-template
  only:
    - docker
  variables:
    VERSION: 2.0.0-beta
    CI_CONTAINER_INSTANCE_NAME: arsnova-click-backend-beta
  script:
    - *staging-server-env
    - *docker-push

deploy:
  stage: deploy
  only:
    - master
    - staging
    - beta
    - docker
  tags:
    - ssh
  script:
    - source variables
    - eval $(ssh-agent -s)
    - mkdir ~/.ssh
    - ssh-keyscan "$SSH_URL" >> ~/.ssh/known_hosts
    - ssh-add <(cat private_key)
    - ssh $SSH_CMD "docker pull $CI_IMAGE_NAME:$VERSION && docker rm -f $CI_CONTAINER_INSTANCE_NAME && docker run -d -p 3010 --name=$CI_CONTAINER_INSTANCE_NAME $CI_IMAGE_NAME:$VERSION && docker image prune -af"
